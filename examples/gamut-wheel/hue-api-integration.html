<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iro.js Gamut Wheel - Philips Hue API Integration</title>
  <!-- Use local build that includes GamutWheel component -->
  <script src="../../dist/iro.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      font-size: 32px;
      margin-bottom: 10px;
      color: #333;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .config-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .config-section h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: #333;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 500;
      color: #555;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 14px 32px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .picker-section {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 40px;
      align-items: start;
      margin-bottom: 30px;
    }

    #picker {
      display: flex;
      justify-content: center;
    }

    .status-section {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
    }

    .status-section h3 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #333;
    }

    #status {
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.5;
      font-family: 'Courier New', monospace;
    }

    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #4caf50;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }

    .status.info {
      background: #e3f2fd;
      color: #1565c0;
      border-left: 4px solid #2196f3;
    }

    .instructions {
      background: #fff3e0;
      padding: 25px;
      border-radius: 12px;
      border-left: 4px solid #ff9800;
      margin-bottom: 30px;
    }

    .instructions h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
    }

    .instructions ol {
      margin-left: 20px;
    }

    .instructions li {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .warning {
      background: #ffebee;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #f44336;
      margin-top: 30px;
    }

    .warning h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #c62828;
    }

    .warning p {
      margin-bottom: 10px;
      line-height: 1.6;
      color: #555;
    }

    .troubleshooting {
      margin-top: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .troubleshooting h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
    }

    .troubleshooting ul {
      margin-left: 20px;
    }

    .troubleshooting li {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .picker-section {
        grid-template-columns: 1fr;
      }

      .container {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Philips Hue API Integration</h1>
    <p class="subtitle">Control your Philips Hue lights directly from the color picker</p>

    <div class="instructions">
      <h3>Setup Instructions</h3>
      <ol>
        <li><strong>Find your Hue Bridge IP address</strong> - Check your router or use the Philips Hue app</li>
        <li><strong>Generate an API username</strong> - Press the link button on your bridge and call the API</li>
        <li><strong>Enter your light ID</strong> - Usually 1, 2, 3, etc. (check via API or app)</li>
        <li><strong>Select the appropriate gamut</strong> - Choose A, B, or C based on your bulb generation</li>
        <li><strong>Click Connect</strong> - Start controlling your lights!</li>
      </ol>
    </div>

    <div class="config-section">
      <h2>Bridge Configuration</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="bridge-ip">Bridge IP Address</label>
          <input type="text" id="bridge-ip" placeholder="192.168.1.100" value="">
        </div>
        <div class="form-group">
          <label for="username">API Username</label>
          <input type="text" id="username" placeholder="your-api-username" value="">
        </div>
        <div class="form-group">
          <label for="light-id">Light ID</label>
          <input type="number" id="light-id" placeholder="1" value="1" min="1">
        </div>
        <div class="form-group">
          <label for="gamut-select">Gamut Type</label>
          <select id="gamut-select">
            <option value="A">Gamut A (1st gen)</option>
            <option value="B">Gamut B (2nd gen)</option>
            <option value="C" selected>Gamut C (3rd gen - latest)</option>
          </select>
        </div>
      </div>
      <button id="connect-btn" class="btn">Connect to Bridge</button>
    </div>

    <div class="picker-section">
      <div id="picker"></div>
      <div class="status-section">
        <h3>Status</h3>
        <div id="status" class="status info">Configure your bridge and click Connect to start</div>
      </div>
    </div>

    <div class="warning">
      <h3>⚠️ Security Note</h3>
      <p>This example uses HTTP requests for simplicity. In production, use HTTPS and secure your API credentials.</p>
      <p>For local development, you may need to run a CORS proxy or configure your Hue bridge to allow cross-origin requests.</p>
    </div>

    <div class="troubleshooting">
      <h3>Troubleshooting</h3>
      <ul>
        <li><strong>CORS errors:</strong> Use a local proxy or browser extension to bypass CORS restrictions during development</li>
        <li><strong>Connection refused:</strong> Ensure your bridge IP is correct and accessible from your network</li>
        <li><strong>Unauthorized:</strong> Generate a new API username by pressing the link button on your bridge</li>
        <li><strong>Color not changing:</strong> Verify the light ID is correct and the bulb is powered on</li>
      </ul>
    </div>
  </div>

  <script>
    var colorPicker;
    var hueConfig = {
      bridgeIp: '',
      username: '',
      lightId: 1,
      gamut: 'C'
    };

    // Initialize color picker
    function initColorPicker(gamut) {
      if (colorPicker) {
        colorPicker.base.remove();
      }

      colorPicker = new iro.ColorPicker('#picker', {
        width: 320,
        color: '#ff6b35',
        gamut: gamut,
        matrixProfile: 'nodehue_d50_typo',
        wheelLightness: true,
        handleRadius: 10,
        borderWidth: 2,
        borderColor: '#ffffff',
        layout: [
          { component: iro.ui.GamutWheel },
          { component: iro.ui.Slider, options: { sliderType: 'value' } }
        ]
      });

      // Send color to Hue on user interaction
      colorPicker.on('input:change', function(color) {
        sendColorToHue(color);
      });
    }

    // Send color to Philips Hue API
    function sendColorToHue(color) {
      if (!hueConfig.bridgeIp || !hueConfig.username) {
        updateStatus('Error: Bridge IP and username required', 'error');
        return;
      }

      // Get xy chromaticity coordinates
      var xy = color.xy;

      // Get brightness (convert from 0-100 to 0-254)
      var brightness = Math.round(color.value * 2.54);

      // Construct Hue API payload
      var payload = {
        xy: [xy.x, xy.y],
        bri: brightness,
        transitiontime: 4 // 400ms transition
      };

      // API endpoint
      var url = 'http://' + hueConfig.bridgeIp + '/api/' +
                hueConfig.username + '/lights/' + hueConfig.lightId + '/state';

      // Send to Hue bridge
      fetch(url, {
        method: 'PUT',
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        updateStatus('Color sent: xy=[' + xy.x.toFixed(4) + ', ' +
                     xy.y.toFixed(4) + '], bri=' + brightness, 'success');
        console.log('Hue API response:', data);
      })
      .catch(error => {
        updateStatus('Error: ' + error.message, 'error');
        console.error('Hue API error:', error);
      });
    }

    // Update status display
    function updateStatus(message, type) {
      var statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = 'status ' + type;
    }

    // Connect button handler
    document.getElementById('connect-btn').addEventListener('click', function() {
      hueConfig.bridgeIp = document.getElementById('bridge-ip').value;
      hueConfig.username = document.getElementById('username').value;
      hueConfig.lightId = parseInt(document.getElementById('light-id').value);
      hueConfig.gamut = document.getElementById('gamut-select').value;

      if (hueConfig.bridgeIp && hueConfig.username) {
        initColorPicker(hueConfig.gamut);
        updateStatus('Connected to bridge at ' + hueConfig.bridgeIp, 'success');
      } else {
        updateStatus('Please enter bridge IP and username', 'error');
      }
    });

    // Initialize with default gamut
    initColorPicker('C');
  </script>
</body>
</html>
